#!/usr/bin/bash
set -euo pipefail
trap 'echo -e "${RED}Error en línea $LINENO. Comando: $BASH_COMMAND${NC}"' ERR

# Configurar colores
RED='\033[31m'
GREEN='\033[32m'
YELLOW='\033[33m'
BLUE='\033[34m'
NC='\033[0m'

echo -e "${GREEN}Instalando dependencias principales de Systemd_boot...${NC}"

# ===== Detección automática del procesador =====
detect_microcode() {
    local vendor
    vendor=$(grep -m1 -oP 'vendor_id\s*:\s*\K.*' /proc/cpuinfo | tr -d ' ')
    
    if [[ "$vendor" == *"GenuineIntel"* ]]; then
        echo -e "\033[32mIntel detectado. Instalando intel-ucode\033[0m"
        microcode="intel-ucode"
    elif [[ "$vendor" == *"AuthenticAMD"* ]]; then
        echo -e "\033[32mAMD detectado. Instalando amd-ucode\033[0m"
        microcode="amd-ucode"
    else
        echo -e "\033[32mProcesador no reconocido. No se instalará microcódigo.\033[0m"
        microcode=""
    fi
}

# Llamar a la función de detección
detect_microcode

# Instalar microcódigo si se detectó
if [[ -n "$microcode" ]]; then
    pacman -S --needed --noconfirm --overwrite='*' "$microcode"
fi

# Verificar si /boot está montado correctamente
if ! mountpoint -q /boot; then
    echo -e "${RED}Error: /boot no está montado correctamente${NC}"
    exit 1
fi

#Instalar systemd-boot
bootctl install

#Restringiendo permisos
chmod 700 /boot
chmod 600 /boot/loader/random-seed 2>/dev/null || true

echo -e "${GREEN}Crear archivo de configuración principal${NC}"

echo "default arch.conf
timeout 3
console-mode keep
editor no" > /boot/loader/loader.conf

echo -e "${GREEN}Crear entrada de arranque${NC}"

# Obtener UUID de la partición root
ROOT_UUID=$(blkid -s UUID -o value /dev/disk/by-label/ARCH_ROOT 2>/dev/null || blkid -s UUID -o value $(findmnt -n -o SOURCE /))

if [[ -z "$ROOT_UUID" ]]; then
    echo -e "${RED}Error: No se pudo obtener el UUID de la partición root${NC}"
    exit 1
fi

# Crear entrada para instalación SIN encriptación
if [[ -n "$microcode" ]]; then
    echo "title Arch Linux
linux /vmlinuz-linux
initrd /$microcode.img
initrd /initramfs-linux.img
options root=UUID=$ROOT_UUID rw" > /boot/loader/entries/arch.conf
else
    echo "title Arch Linux
linux /vmlinuz-linux
initrd /initramfs-linux.img
options root=UUID=$ROOT_UUID rw" > /boot/loader/entries/arch.conf
fi

mkinitcpio -P

# Remover GRUB si existe para evitar conflictos
pacman -Rns grub efibootmgr --noconfirm 2>/dev/null || true

echo -e "${GREEN}systemd-boot configurado correctamente${NC}"

# Instalación de paquetes adicionales
echo -e "${GREEN}==== EXTRAS ====${NC}"
./extras
